import { useEffect, useState, useRef } from "react";
import { useQuery } from "@tanstack/react-query";
import { useParams, useLocation } from "wouter";
import { Send, Users, UserPlus, Smile } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Card } from "@/components/ui/card";
import EmojiPicker, { Theme, EmojiClickData } from "emoji-picker-react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogClose,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import DashboardLayout from "@/components/dashboard-layout";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { Helmet } from "react-helmet";
import { io, Socket } from "socket.io-client";
import { useCustomToast } from "@/components/ui/custom-toast";
import { useDebugUser } from "@/hooks/use-debug-user";

// Ù†ÙˆØ¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
interface GroupMessage {
  id: number;
  groupId: number;
  senderId: number;
  content: string;
  createdAt: string;
  senderName: string;
}

// Ù†ÙˆØ¹ Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
interface GroupMember {
  id: number;
  groupId: number;
  userId: number;
  role: string;
  joinedAt: string;
  fullName: string;
}

// Ù†ÙˆØ¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
interface GroupChat {
  id: number;
  name: string;
  description: string | null;
  creatorId: number;
  isPrivate: boolean;
  createdAt: string;
}

// Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø¥Ø¶Ø§ÙØ©
interface AvailableUser {
  id: number;
  fullName: string;
}

export default function GroupChatPage() {
  const { groupId } = useParams<{ groupId: string }>();
  const [_, navigate] = useLocation();
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const [newMessage, setNewMessage] = useState("");
  const [socket, setSocket] = useState<Socket | null>(null);
  const { showMessage } = useCustomToast();
  const [addMemberDialogOpen, setAddMemberDialogOpen] = useState(false);
  const [selectedUserId, setSelectedUserId] = useState<number | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [showEmoji, setShowEmoji] = useState(false);
  const [typingTimeout, setTypingTimeout] = useState<ReturnType<typeof setTimeout> | null>(null);
  const [usersTyping, setUsersTyping] = useState<string[]>([]);
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserId = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return null;
      return JSON.parse(userData).id;
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return null;
    }
  };
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserName = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return "Ù…Ø³ØªØ®Ø¯Ù…";
      return JSON.parse(userData).fullName || "Ù…Ø³ØªØ®Ø¯Ù…";
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return "Ù…Ø³ØªØ®Ø¯Ù…";
    }
  };
  
  const currentUserId = getUserId();
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  useDebugUser();

  // Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const {
    data: group,
    isLoading: isGroupLoading,
    error: groupError,
  } = useQuery({
    queryKey: ['/api/chat/groups', groupId],
    enabled: !!groupId,
    retry: false,
  });

  // Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const {
    data: messages,
    isLoading: isMessagesLoading,
    error: messagesError,
  } = useQuery({
    queryKey: [`/api/chat/groups/${groupId}/messages`],
    enabled: !!groupId,
    refetchOnWindowFocus: false,
  });

  // Ø¬Ù„Ø¨ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const {
    data: members,
    isLoading: isMembersLoading,
    error: membersError,
  } = useQuery({
    queryKey: [`/api/chat/groups/${groupId}/members`],
    enabled: !!groupId,
    refetchOnWindowFocus: false,
  });

  // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù„Ù„Ø¥Ø¶Ø§ÙØ©
  const {
    data: availableUsers,
    isLoading: isAvailableUsersLoading,
  } = useQuery({
    queryKey: ['/api/users/available'],
    enabled: addMemberDialogOpen,
  });

  // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØµØ§Ù„ Socket.IO Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
  useEffect(() => {
    if (!groupId) return;

    console.log("Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Socket.IO Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...");
    
    const newSocket = io('/', {
      path: '/socket.io',
      transports: ['websocket'],
      reconnection: true
    });
    
    newSocket.on('connect', () => {
      console.log("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Socket.IO Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:", newSocket.id);
      setIsConnected(true);
      
      // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
      newSocket.emit('joinGroupChat', parseInt(groupId));
    });

    newSocket.on('disconnect', () => {
      console.log("âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª");
      setIsConnected(false);
    });
    
    newSocket.on('newGroupMessage', (data: any) => {
      console.log("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©:", data);
      
      if (data && data.groupId === parseInt(groupId)) {
        queryClient.invalidateQueries({ queryKey: [`/api/chat/groups/${groupId}/messages`] });
      }
    });
    
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙƒØªØ§Ø¨Ø©
    newSocket.on('userTyping', (data: { userId: number; userName: string }) => {
      console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†:", data);
      if (data.userId !== currentUserId) {
        setUsersTyping(prev => {
          if (!prev.includes(data.userName)) {
            console.log("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†:", data.userName);
            return [...prev, data.userName];
          }
          return prev;
        });
      }
    });
    
    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©
    newSocket.on('userStoppedTyping', (data: { userId: number; userName: string }) => {
      console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©:", data);
      if (data.userId !== currentUserId) {
        setUsersTyping(prev => {
          console.log("Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªØ®Ø¯Ù… ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©:", data.userName);
          return prev.filter(name => name !== data.userName);
        });
      }
    });

    setSocket(newSocket);

    return () => {
      newSocket.disconnect();
    };
  }, [groupId, queryClient]);

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserId = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return null;
      return JSON.parse(userData).id;
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return null;
    }
  };
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserName = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return "Ù…Ø³ØªØ®Ø¯Ù…";
      return JSON.parse(userData).fullName || "Ù…Ø³ØªØ®Ø¯Ù…";
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return "Ù…Ø³ØªØ®Ø¯Ù…";
    }
  };
  
  const currentUserId = getUserId();
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙƒØªØ§Ø¨Ø©
  useEffect(() => {
    if (!socket || !groupId || !currentUserId) return;
    
    if (newMessage.trim()) {
      // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†"
      socket.emit('typing', { 
        roomType: 'group', 
        roomId: parseInt(groupId), 
        userId: currentUserId, 
        userName: getUserName() 
      });
      
      // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚Øª Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
      const newTimeout = setTimeout(() => {
        socket.emit('stopTyping', { 
          roomType: 'group', 
          roomId: parseInt(groupId), 
          userId: currentUserId,
          userName: getUserName()
        });
      }, 2000);
      
      setTypingTimeout(newTimeout);
    } else {
      // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§ Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
      socket.emit('stopTyping', { 
        roomType: 'group', 
        roomId: parseInt(groupId), 
        userId: currentUserId,
        userName: getUserName()
      });
    }
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†
    return () => {
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
    };
  }, [newMessage, socket, groupId, currentUserId, typingTimeout]);
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserName = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return "Ù…Ø³ØªØ®Ø¯Ù…";
      return JSON.parse(userData).fullName || "Ù…Ø³ØªØ®Ø¯Ù…";
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return "Ù…Ø³ØªØ®Ø¯Ù…";
    }
  };

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTP API
  const sendMessage = async () => {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ§Øª
    const messageText = newMessage.trim();
    if (!messageText) {
      showMessage("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©", true);
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    if (!groupId) {
      showMessage("Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±", true);
      return;
    }
    
    // Ø¹Ø¯Ù… Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø³ÙŠØ³ØªØ®Ø¯Ù… ØªÙˆÙƒÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    console.log("Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©:", messageText);

    try {
      // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† apiRequest Ù„Ù„ØªØ´Ø®ÙŠØµ
      const token = localStorage.getItem("auth_token");
      if (!token) {
        console.log("âŒ ØªÙˆÙƒÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
        showMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", true);
        return;
      } else {
        console.log("âœ… ØªÙˆÙƒÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…ÙˆØ¬ÙˆØ¯:", token.substring(0, 15) + "...");
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      const messageData = {
        content: messageText
      };
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ†
      console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± API...");
      console.log("ğŸ”¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", messageData);
      
      const response = await fetch(`/api/chat/groups/${groupId}/messages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(messageData)
      });
      
      console.log("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:", response.status);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
      }
      
      console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
      
      // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      setNewMessage("");
      
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      queryClient.invalidateQueries({ queryKey: [`/api/chat/groups/${groupId}/messages`] });
      
      // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
      setTimeout(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, 100);
    } catch (error: any) {
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
      console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ù† toast Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
      const errorMessage = error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
      console.log("Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£:", errorMessage);
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… showMessage Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† toast Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
      showMessage("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + errorMessage, true);
    }
  };

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯
  const handleAddMember = async () => {
    if (!selectedUserId || !groupId) {
      showMessage("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØªÙ‡", true);
      return;
    }

    try {
      const res = await apiRequest(
        "POST",
        `/api/chat/groups/${groupId}/members`,
        { memberId: selectedUserId, role: "member" }
      );

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || "ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ");
      }

      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
      queryClient.invalidateQueries({ queryKey: [`/api/chat/groups/${groupId}/members`] });
      
      showMessage("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­", false);
      
      setAddMemberDialogOpen(false);
      setSelectedUserId(null);
    } catch (error: any) {
      showMessage(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ", true);
    }
  };

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const getUserId = () => {
    try {
      const userData = localStorage.getItem("user");
      if (!userData) return null;
      return JSON.parse(userData).id;
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
      return null;
    }
  };
  
  const currentUserId = getUserId();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const isAdmin = Array.isArray(members) && members.some(
    (member: GroupMember) => member.userId === currentUserId && member.role === "admin"
  );

  // ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
  const formattedMessages = Array.isArray(messages) ? [...messages].reverse() : [];

  if (isGroupLoading) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center min-h-[300px]">
          <div className="loader"></div>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <Helmet>
        <title>{group && group.name ? group.name : "Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø©"} | Ù…Ù†ØµØ© Ø§Ù„ØµØ±Ø§ÙØ©</title>
        <meta name="description" content={`Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© - ${group && group.name ? group.name : ""}`} />
      </Helmet>

      <div className="container py-6 max-w-screen-xl mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */}
          <div className="lg:col-span-1">
            <Card className="p-4 mb-4">
              <h2 className="text-xl font-bold mb-2">{group && group.name ? group.name : "Ù…Ø¬Ù…ÙˆØ¹Ø©"}</h2>
              {group && group.description && (
                <p className="text-gray-600 mb-4">{group.description}</p>
              )}
              <div className="flex items-center space-x-2 mb-2">
                <Users size={18} />
                <span className="text-sm mr-2">
                  {Array.isArray(members) ? members.length : 0} Ø¹Ø¶Ùˆ
                </span>
              </div>
              <div className="mt-4">
                <Button 
                  variant="outline" 
                  size="sm" 
                  className="w-full" 
                  onClick={() => navigate("/dashboard")}
                >
                  Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </Button>
              </div>
            </Card>

            <Card className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                {isAdmin && (
                  <Dialog open={addMemberDialogOpen} onOpenChange={setAddMemberDialogOpen}>
                    <DialogTrigger asChild>
                      <Button size="sm" variant="outline">
                        <UserPlus size={16} className="ml-2" />
                        Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-[425px]">
                      <DialogHeader>
                        <DialogTitle>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</DialogTitle>
                        <DialogDescription>
                          Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
                        </DialogDescription>
                      </DialogHeader>
                      <div className="grid gap-4 py-4">
                        <Select
                          value={selectedUserId?.toString() || ""}
                          onValueChange={(value) => setSelectedUserId(parseInt(value))}
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹" />
                          </SelectTrigger>
                          <SelectContent>
                            {isAvailableUsersLoading ? (
                              <SelectItem value="loading" disabled>
                                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                              </SelectItem>
                            ) : (
                              availableUsers && Array.isArray(availableUsers) && availableUsers
                                .filter((user: AvailableUser) => 
                                  !members?.some((member: GroupMember) => member.userId === user.id)
                                )
                                .map((user: AvailableUser) => (
                                  <SelectItem key={user.id} value={user.id.toString()}>
                                    {user.fullName}
                                  </SelectItem>
                                ))
                            )}
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="flex justify-end gap-3">
                        <DialogClose asChild>
                          <Button variant="outline">Ø¥Ù„ØºØ§Ø¡</Button>
                        </DialogClose>
                        <Button type="button" onClick={handleAddMember}>
                          Ø¥Ø¶Ø§ÙØ©
                        </Button>
                      </div>
                    </DialogContent>
                  </Dialog>
                )}
              </div>

              {isMembersLoading ? (
                <div className="flex justify-center p-4">
                  <div className="loader"></div>
                </div>
              ) : (
                <ScrollArea className="h-[300px] pr-4">
                  <div className="space-y-2">
                    {Array.isArray(members) && members.map((member: GroupMember) => (
                      <div
                        key={member.id}
                        className="flex items-center justify-between p-2 rounded-md hover:bg-gray-100"
                      >
                        <span>{member.fullName}</span>
                        {member.role === "admin" && (
                          <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                            Ù…Ø¯ÙŠØ±
                          </span>
                        )}
                      </div>
                    ))}
                  </div>
                </ScrollArea>
              )}
            </Card>
          </div>

          {/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */}
          <div className="lg:col-span-3 flex flex-col h-[calc(100vh-220px)]">
            <Card className="flex-1 mb-4 p-4 overflow-hidden">
              {isMessagesLoading ? (
                <div className="flex justify-center items-center h-full">
                  <div className="loader"></div>
                </div>
              ) : formattedMessages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-gray-500">
                  <p className="mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>
                  <p>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</p>
                </div>
              ) : (
                <ScrollArea className="h-full pr-4">
                  <div className="space-y-4">
                    {formattedMessages.map((message: GroupMessage) => (
                      <div
                        key={message.id}
                        className={`flex ${
                          message.senderId === currentUserId ? "justify-end" : "justify-start"
                        }`}
                      >
                        <div
                          className={`max-w-[80%] px-4 py-2 rounded-lg ${
                            message.senderId === currentUserId
                              ? "bg-blue-500 text-white"
                              : "bg-gray-100"
                          }`}
                        >
                          {message.senderId !== currentUserId && (
                            <div className="font-bold text-sm text-gray-600 mb-1">
                              {message.senderName}
                            </div>
                          )}
                          <div className="text-sm">{message.content}</div>
                          <div className="text-xs mt-1 opacity-70">
                            {new Date(message.createdAt).toLocaleTimeString("ar-LY", {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}
                          </div>
                        </div>
                      </div>
                    ))}
                    <div ref={messagesEndRef} />
                  </div>
                </ScrollArea>
              )}
            </Card>

            <div className="flex flex-col gap-2">
              <div className="flex gap-2">
                <Input
                  placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                      e.preventDefault();
                      sendMessage();
                    }
                  }}
                  dir="rtl"
                />
                <Button 
                  onClick={() => sendMessage()} 
                  size="icon"
                  title="Ø¥Ø±Ø³Ø§Ù„"
                >
                  <Send size={18} />
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}